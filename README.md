# Running a Local HTTPS Server with Docker

This guide will help you set up a local HTTPS server using Docker with Nginx and self-signed SSL certificates. The main reason for using Docker is the space taken up by servers and how long it takes to build/rebuild the servers.

## Prerequisites

### 1. Install mkcert

To generate trusted local SSL certificates, install [mkcert](https://github.com/FiloSottile/mkcert):

```bash
# macOS (using Homebrew)
brew install mkcert
brew install nss # if you use Firefox

# Linux (using Homebrew or package manager)
brew install mkcert
# or follow instructions at https://github.com/FiloSottile/mkcert

# Windows
choco install mkcert
```

### 2. Set up IP Alias (macOS/Linux)

Create an IP alias for your local server:

```bash
# Add IP alias (run once per boot, or add to startup script)
sudo ifconfig lo0 alias 10.1.1.30
```

### 3. Create Docker Network

Create a shared Docker network (run once):

```bash
docker network create --driver bridge --subnet=10.1.1.0/24 local_network
```

## Initial Setup (Run Once)

### 1. Create Project Directory

```bash
mkdir websrvd
cd websrvd
```

### 2. Generate SSL Certificates

```bash
# Install mkcert root CA
mkcert -install

# Generate certificates for your domains
mkcert -cert-file localhost.pem -key-file localhost-key.pem websrv 10.1.1.30 localhost
```

### 3. Create Required Files

Create these files in your project directory:

- `Dockerfile`
- `docker-compose.yml`
- `nginx.conf`

**Important:** You must generate the SSL certificates before building the Docker image.

### 4. Download Base Image (Optional)

```bash
docker pull nginx:alpine
```

## Configuration Options

This project supports flexible IP configuration through environment variables:

### Default Configuration

```bash
# Uses IP 10.1.1.30 (default)
docker-compose up -d
```

### Custom IP Address

```bash
# Use different IP address
WEBSRV_IP=10.1.1.50 docker-compose up -d

# Or set permanently
export WEBSRV_IP=10.1.1.50
docker-compose up -d
```

### Using .env File

Create a `.env` file for persistent configuration:

```bash
echo "WEBSRV_IP=10.1.1.30" > .env
echo "WEBSRV_PORT=443" >> .env
```

## Running the Server

### Docker Compose (Recommended)

```bash
# Build and start the server
docker-compose up --build -d

# With custom IP
WEBSRV_IP=10.1.1.31 docker-compose up --build -d

# With custom IP and port
WEBSRV_IP=10.1.1.31 WEBSRV_PORT=8443 docker-compose up --build -d

# Stop the server
docker-compose down
```

### Manual Docker Commands

```bash
# Build the image
docker build -t websrvd .

# Run the container
docker run -d -p 10.1.1.30:443:443 --name websrvd \
  -v ${HOME}/repos:/usr/share/nginx/html websrvd

# Stop and cleanup
docker stop websrvd
docker rm websrvd
docker rmi websrvd  # Optional: remove image
```

## Using with Terraform

1. **Initialize and apply Terraform:**

    ```bash
    # Reconfigure backend, ignoring any saved configuration
    terraform init -reconfigure
    
    # Validate terraform files
    terraform validate
    
    # Format files (optional)
    terraform fmt -diff -recursive
    
    # Apply configuration
    terraform apply -auto-approve
    
    # To remove resources
    terraform destroy -auto-approve
    ```

## Verification

Open your web browser and navigate to:

- `https://websrv/` (using hostname)
- `https://10.1.1.30/` (using IP address)
- `https://localhost/` (local access)

You should **NOT** see SSL certificate warnings thanks to mkcert.

## Volume Mount Paths

Volume mount paths must be absolute and OS-specific:

### macOS/Linux

```yaml
volumes:
  - ${HOME}/repos:/usr/share/nginx/html
```

### Windows (Git Bash/WSL)

```yaml
volumes:
  - /c/Users/<YourUsername>/repos:/usr/share/nginx/html
```

### Windows (CMD/PowerShell)  

```yaml
volumes:
  - C:\Users\<YourUsername>\repos:/usr/share/nginx/html
```

**Note:** The path before the colon is on your host machine; the path after the colon is inside the container.

## Troubleshooting

### SSL Certificate Issues

```bash
# Regenerate certificates if needed
mkcert -cert-file localhost.pem -key-file localhost-key.pem websrv 10.1.1.30 localhost

# Reinstall mkcert CA
mkcert -uninstall
mkcert -install
```

### Network Connectivity Issues

```bash
# Test IP alias
ping -c 1 10.1.1.30

# Check Docker network
docker network inspect local_network

# Test container connectivity
curl https://10.1.1.30/
```

### Useful Commands

```bash
# View container logs
docker-compose logs

# Follow logs in real-time
docker-compose logs -f

# Access container shell
docker-compose exec nginx sh

# Check running containers and health status
docker-compose ps

# Check network interfaces
ifconfig lo0 | grep "inet 10.1.1"

# Run network test script
./test-setup.sh
```

## Directory Structure

```text
websrvd/
├── Dockerfile
├── docker-compose.yml
├── nginx.conf
├── localhost.pem          # Generated by mkcert
├── localhost-key.pem      # Generated by mkcert
├── .env                   # Optional: environment variables
└── README.md
```

## Security Notes

- SSL certificates are only trusted on the machine where mkcert was installed
- This setup is for **local development only** - do not use in production
- The `server_tokens off` directive in nginx.conf hides version information
- Rate limiting is configured to prevent abuse
